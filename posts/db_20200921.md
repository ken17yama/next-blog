---
title: 'ユーザーと所属するグループをデータベースで表現する'
created: '2020-09-21'
modified: '2020-09-21'
category: 'データベース'
tags: ['データベース', '設計', 'MySQL', 'アンチパターン' ]
---

こんにちは！<br>
ユーザーとグループ（チームや組織）をデータベースで表現しようとしている、やまだです。

今回はデータベース（今回はMySQL）で、ユーザーとそれらが所属するグループの表現をしようとしたときのメモを記載します。
まず、以下のように**users**と**groups**のテーブルを定義します。

**■usersテーブル**
id  | name
---- | ----
1  | やまだ
2  | 嫁
3  | ながさわ
4  | まつ

**■groupsテーブル**
id|name
----|----
1|やまだ家
2|女優
3|女性

それぞれのユーザーがどこのグループに所属しているのかを表現するのが良いでしょうか。
自分がこれを始めてみた時には、既存の**users**もしくは**groups**のテーブルどちらかに配列のフィールドを追加し、そこに都度ユーザーやグループを登録していけばいいのではないかと考えました。（PHPのarray_pushのように…）

**例えばこんなふうに…**
id|name|users
----|----|----
1|やまだ家|[1, 2]
2|女優|[3, 4]
3|女性|[2, 3, 4]

**しかしこれはアンチパターンと呼ばれるものです！**

では、なぜだめなのか考えてみましょう。
例えば「嫁」が所属するグループを調べたいとき、おそらく「LIKE句」等で検索する方法に行きつくのではないでしょうか。
少しのデータをならそこまで影響は出ないかもしれませんが、データが増えるにつれてパフォーマンスがおちたり、おなじ文字列を含むものまで一緒に取得することになってしまいませんか？（もちろん，をうまく利用して一致させる事もできそうですが）

これを解決する方法は以下のような**交差テーブル**をつくってあげることです。

**■交差テーブル（group_user）**
user_id|group_id
----|----
1|1
2|1
2|3
3|2
3|3
4|2
4|3

**■usersテーブル**
id|name
----|----
1|やまだ
2|嫁
3|ながさわ
4|まつ

**■groupsテーブル**
id|name
----|----
1|やまだ家
2|女優
3|女性


このようにすることで、例えば「嫁」の所属するグループを知りたいときは以下のようなSQLを叩けばほしい情報を取得することができます。
```
SELECT gu.group_id, g.name FROM users AS u
	INNER JOIN group_user AS gu ON u.id = gu.user_id
	INNER JOIN groups AS g ON gu.group_id = g.id
WHERE u.id = 2;
```

**■所属グループ**
group_id|name
----|----
1|やまだ家
2|女優
3|女性

以上でアンチパターンを回避したユーザーのグループ管理ができるかと思います！ではまた！

## 参考
- [関係データベースにおける配列の表現](http://www.flint.jp/blog/?entry=23)
- [データベース論理設計のアンチパターン](https://kyabatalian.hatenablog.com/entry/2016/12/19/193430)
- [SQLアンチパターン：ジェイウォーク（信号無視）](https://qiita.com/matsuhisa_h/items/6b4e552f4b6eb7d72d60)
